-- server.lua
local port = 1234
local users = {}
local tweets = {}

-- Helper functions
local function saveData()
    local file = fs.open("data/users.txt", "w")
    file.write(textutils.serialize(users))
    file.close()

    file = fs.open("data/tweets.txt", "w")
    file.write(textutils.serialize(tweets))
    file.close()
end

local function loadData()
    if fs.exists("data/users.txt") then
        local file = fs.open("data/users.txt", "r")
        users = textutils.unserialize(file.readAll())
        file.close()
    end

    if fs.exists("data/tweets.txt") then
        local file = fs.open("data/tweets.txt", "r")
        tweets = textutils.unserialize(file.readAll())
        file.close()
    end
end

local function handleRequest(data)
    if data.type == "createUser" then
        if not users[data.username] then
            users[data.username] = {followers = 0, following = 0, bio = "", profilePicture = ""}
            saveData()
            return "User created: " .. data.username
        else
            return "User already exists."
        end
    elseif data.type == "tweet" then
        if users[data.username] then
            table.insert(tweets, {user = data.username, message = data.message, time = os.time()})
            saveData()
            return "Tweet posted by " .. data.username
        else
            return "User not found."
        end
    elseif data.type == "showProfile" then
        if users[data.username] then
            return textutils.serialize(users[data.username])
        else
            return "User not found."
        end
    elseif data.type == "followUser" then
        if users[data.follower] and users[data.followee] then
            users[data.followee].followers = users[data.followee].followers + 1
            users[data.follower].following = users[data.follower].following + 1
            saveData()
            return data.follower .. " is now following " .. data.followee
        else
            return "User not found."
        end
    elseif data.type == "unfollowUser" then
        if users[data.follower] and users[data.followee] then
            users[data.followee].followers = users[data.followee].followers - 1
            users[data.follower].following = users[data.follower].following - 1
            saveData()
            return data.follower .. " has unfollowed " .. data.followee
        else
            return "User not found."
        end
    elseif data.type == "viewTweets" then
        local userTweets = {}
        for _, tweet in ipairs(tweets) do
            if tweet.user == data.username then
                table.insert(userTweets, tweet)
            end
        end
        return textutils.serialize(userTweets)
    elseif data.type == "updateProfile" then
        if users[data.username] then
            users[data.username].bio = data.bio
            users[data.username].profilePicture = data.profilePicture
            saveData()
            return "Profile updated for " .. data.username
        else
            return "User not found."
        end
    else
        return "Invalid request."
    end
end

-- Main server loop
loadData()
rednet.open("back")
while true do
    local senderId, message = rednet.receive(port)
    local request = textutils.unserialize(message)
    local response = handleRequest(request)
    rednet.send(senderId, response)
end
